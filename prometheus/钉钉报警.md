# 钉钉报警

## 设置钉钉webhook
![钉钉截图](https://github.com/deanls1/note/blob/main/static/1656986418474.jpg)
## 下载 prometheus-webhook-dingtalk
~~~
#### github
wget https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v2.1.0/prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz
#### gitee
wget https://gitee.com/deanls/prometheus-webhook-dingtalk/attach_files/1116983/download/prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz
tar zxvf prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz
mv prometheus-webhook-dingtalk-2.1.0.linux-amd64 dingtalk/
~~~
## 启动 prometheus-webhook-dingtalk
~~~
cd dingtalk/
nohup ./prometheus-webhook-dingtalk --ding.profile="webhook1=https://oapi.dingtalk.com/robot/send?access_to
ken=bd1b268df40daec5dadf62fcddc012f6b5ed5143e24ffcf754ff75617b47c7a8" > ./ding.log 2>&1 &
~~~
## 修改配置文件alertmanager.yml
~~~
vim /etc/alertmanager/alertmanager.yml 

global:
  resolve_timeout: 5m
route:
  receiver: webhook1
  group_wait: 30s
  group_interval: 1m
  repeat_interval: 1h
  group_by: [alertname]
  routes:
  - receiver: 'webhook1'
    group_wait: 10s
receivers:
- name: 'webhook1'
  webhook_configs:
  - url: http://34.92.15.178:8060/dingtalk/webhook1/send
    send_resolved: true
~~~
## 配置告警规则
~~~
vim /etc/alertmanager/alertmanager.yml

global:
  resolve_timeout: 5m
route:
  receiver: webhook1
  group_wait: 30s
  group_interval: 1m
  repeat_interval: 1h
  group_by: [alertname]
  routes:
  - receiver: 'webhook1'
    group_wait: 10s
receivers:
- name: 'webhook1'
  webhook_configs:
  - url: http://34.92.15.178:8060/dingtalk/webhook1/send
    send_resolved: true
root@instance-6:~/dingtalk# cat /home/docker/prometheus/rule/host.yml 
groups:
- name: 磁盘告警规则
  rules:
  - alert: 磁盘使用率
    expr: (node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes * 100 > 1
    for: 1m
    labels:
      user: prometheus
      severity: warning
    annotations:
      description: "磁盘分区{{ $labels.mountpoint }}空间使用率超过90% (当前: {{ $value }}%)"
~~~
## 修改prometheus配置让报警生效,并重启
~~~
vim /home/docker/prometheus/prometheus.yml 

alerting: #alertmanager相关配置
  alertmanagers:
  - static_configs:
    - targets:
       - 34.92.15.178:9093 #alertmanager地址
rule_files: #加载规则文件 
  - "/etc/prometheus/rule/*.yml"   ##指定告警模版的地址
  
docker restart prometheus
docker restart alertmanager
~~~
